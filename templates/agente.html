{% extends "base.html" %}

{% block title %}Agente de IA{% endblock %}
{% block header_title %}Agente de IA{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Agente de IA</h1>
        <p class="page-subtitle">Estado del agente inteligente que responde automáticamente a los clientes de Madness
            Light</p>
    </div>
</div>

<!-- Agent Status Card -->
<div class="kpi-grid" style="grid-template-columns:repeat(3, 1fr)">
    <div class="kpi-card kpi-accent-green animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                    d="M12 2a4 4 0 014 4v1a1 1 0 001 1h1a4 4 0 010 8h-1a1 1 0 00-1 1v1a4 4 0 01-8 0v-1a1 1 0 00-1-1H6a4 4 0 010-8h1a1 1 0 001-1V6a4 4 0 014-4z" />
            </svg>
        </div>
        <div class="kpi-label">Estado</div>
        <div class="kpi-value"
            style="font-size:24px;background:linear-gradient(135deg,#22c55e,#39FF14);-webkit-background-clip:text;background-clip:text">
            ● Activo</div>
        <div class="kpi-subtitle">Respondiendo mensajes</div>
    </div>

    <div class="kpi-card kpi-accent-cyan animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
            </svg>
        </div>
        <div class="kpi-label">Conversaciones</div>
        <div class="kpi-value">{{ messages_total }}</div>
        <div class="kpi-subtitle">mensajes procesados</div>
    </div>

    <div class="kpi-card kpi-accent-purple animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
            </svg>
        </div>
        <div class="kpi-label">Tiempo de Respuesta</div>
        <div class="kpi-value" style="font-size:24px">
            < 5 seg</div>
                <div class="kpi-subtitle">respuesta instantánea</div>
        </div>
    </div>

    <!-- Agent Info Cards -->
    <div class="section-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z" />
            <path d="M2 17l10 5 10-5" />
            <path d="M2 12l10 5 10-5" />
        </svg>
        <h2>Configuración del Agente</h2>
    </div>

    <div class="grid-2">
        <!-- What the agent knows -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z" />
                        <path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z" />
                    </svg>
                    Fuentes de Información
                </h3>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px">
                <div class="capability-item">
                    <span class="capability-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path d="M8 2v4M16 2v4" /><rect x="3" y="4" width="18" height="18" rx="2" /><path d="M3 10h18" />
                        </svg>
                    </span>
                    <div>
                        <div class="capability-name">Calendario de eventos</div>
                        <div class="capability-desc">Acceso a todas las fiestas programadas: fechas, salas, temáticas, DJs y precios</div>
                    </div>
                </div>
                <div class="capability-item">
                    <span class="capability-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path d="M3 21h18M3 7v1a3 3 0 006 0V7m0 1a3 3 0 006 0V7m0 1a3 3 0 006 0V7H3l2-4h14l2 4" />
                            <path d="M5 21V10.85M19 21V10.85" />
                        </svg>
                    </span>
                    <div>
                        <div class="capability-name">Perfil de la empresa</div>
                        <div class="capability-desc">Datos de Madness Light: descripción, ubicación, contacto y horarios de eventos</div>
                    </div>
                </div>
                <div class="capability-item">
                    <span class="capability-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" />
                        </svg>
                    </span>
                    <div>
                        <div class="capability-name">Base de conocimiento</div>
                        <div class="capability-desc">Documentación interna sobre entradas, salas activas en Madrid, y programa de RRPP</div>
                    </div>
                </div>
                <div class="capability-item">
                    <span class="capability-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
                        </svg>
                    </span>
                    <div>
                        <div class="capability-name">Historial de conversaciones</div>
                        <div class="capability-desc">Contexto de mensajes previos de cada usuario para respuestas personalizadas</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Capabilities -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
                    </svg>
                    Capacidades
                </h3>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px">
                <div class="capability-item">
                    <span class="capability-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <circle cx="12" cy="12" r="10" /><line x1="12" y1="8" x2="12" y2="12" /><line x1="12" y1="16" x2="12.01" y2="16" />
                        </svg>
                    </span>
                    <div>
                        <div class="capability-name">Info de Fiestas</div>
                        <div class="capability-desc">Responde sobre próximos eventos, salas, temáticas y precios</div>
                    </div>
                </div>
                <div class="capability-item">
                    <span class="capability-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" />
                        </svg>
                    </span>
                    <div>
                        <div class="capability-name">Entradas</div>
                        <div class="capability-desc">Guía a los usuarios a comprar entradas en Elite Events</div>
                    </div>
                </div>
                <div class="capability-item">
                    <span class="capability-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" /><circle cx="12" cy="10" r="3" />
                        </svg>
                    </span>
                    <div>
                        <div class="capability-name">Salas y Ubicaciones</div>
                        <div class="capability-desc">Informa sobre las salas activas en Madrid</div>
                    </div>
                </div>
                <div class="capability-item">
                    <span class="capability-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" /><circle cx="9" cy="7" r="4" />
                            <path d="M23 21v-2a4 4 0 00-3-3.87" /><path d="M16 3.13a4 4 0 010 7.75" />
                        </svg>
                    </span>
                    <div>
                        <div class="capability-name">Programa RRPP</div>
                        <div class="capability-desc">Explica el programa de relaciones públicas cuando se pregunta</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Extra -->
    {% if company and company.extra_info %}
    <div class="card" style="margin-top:20px">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                </svg>
                Base de Conocimiento del Agente
            </h3>
        </div>
        <pre class="knowledge-base-content">{{ company.extra_info }}</pre>
    </div>
    {% endif %}

    <!-- Recent Conversations — Chat View -->
    <div class="card" style="margin-top:20px">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
                </svg>
                Últimas Conversaciones
            </h3>
            <span class="badge badge-platform">{{ messages_total }} mensajes de usuarios</span>
        </div>

        {% if recent_messages %}
        <div class="chat-view">
            {% for msg in recent_messages %}
            <div class="chat-bubble {{ 'chat-user' if msg.role == 'user' else 'chat-bot' }}">
                <div class="chat-bubble-header">
                    <span class="chat-role">{{ 'Usuario ' + msg.user_id[-4:] if msg.role == 'user' else 'Bot Madness' }}</span>
                    <span class="chat-time">{{ msg.created_at.strftime('%d/%m %H:%M') if msg.created_at else '' }}</span>
                </div>
                <div class="chat-bubble-text">{{ msg.content }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
            </svg>
            <h3>Sin conversaciones todavía</h3>
            <p>Las conversaciones del agente aparecerán aquí cuando empiece a funcionar</p>
        </div>
        {% endif %}
    </div>

    {% endblock %}