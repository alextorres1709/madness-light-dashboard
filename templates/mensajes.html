{% extends "base.html" %}

{% block title %}Mensajes{% endblock %}
{% block header_title %}Mensajes Masivos{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Mensajes Masivos</h1>
        <p class="page-subtitle">Envia mensajes a los usuarios del bot de Telegram</p>
    </div>
</div>

{% if not has_token %}
<div class="card" style="border-color:rgba(239,68,68,0.3);margin-bottom:20px">
    <div style="padding:20px;display:flex;align-items:center;gap:12px">
        <svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" width="24" height="24">
            <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
            <line x1="12" y1="9" x2="12" y2="13" />
            <line x1="12" y1="17" x2="12.01" y2="17" />
        </svg>
        <div>
            <strong style="color:#ef4444">TELEGRAM_BOT_TOKEN no configurado</strong>
            <p style="color:var(--text-secondary);font-size:13px;margin-top:4px">Anade la variable TELEGRAM_BOT_TOKEN en Vercel para poder enviar mensajes</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Audience KPIs -->
<div class="kpi-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:24px">
    <div class="kpi-card kpi-accent-green animate-in">
        <div class="kpi-label">Todos los usuarios</div>
        <div class="kpi-value">{{ all_users }}</div>
        <div class="kpi-subtitle">Total historico</div>
    </div>
    <div class="kpi-card kpi-accent-cyan animate-in">
        <div class="kpi-label">Activos (7 dias)</div>
        <div class="kpi-value">{{ active_7d }}</div>
        <div class="kpi-subtitle">Ultima semana</div>
    </div>
    <div class="kpi-card kpi-accent-purple animate-in">
        <div class="kpi-label">Activos (30 dias)</div>
        <div class="kpi-value">{{ active_30d }}</div>
        <div class="kpi-subtitle">Ultimo mes</div>
    </div>
</div>

<!-- Compose -->
<div class="card" style="padding:24px">
    <div class="section-header" style="margin-bottom:20px">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
            <path d="M22 2L11 13" />
            <path d="M22 2L15 22l-4-9-9-4z" />
        </svg>
        <h3>Componer mensaje</h3>
    </div>

    <form method="POST" action="{{ url_for('broadcast.send') }}" onsubmit="return confirm('Â¿Enviar este mensaje a los usuarios seleccionados?')">
        <div style="margin-bottom:20px">
            <label class="form-label" style="margin-bottom:10px;display:block">Audiencia</label>
            <div style="display:flex;gap:10px;flex-wrap:wrap">
                <label style="display:flex;align-items:center;gap:8px;padding:10px 16px;border:1px solid var(--border-color);border-radius:8px;cursor:pointer;font-size:14px;color:var(--text-secondary)">
                    <input type="radio" name="audience" value="all" checked> Todos ({{ all_users }})
                </label>
                <label style="display:flex;align-items:center;gap:8px;padding:10px 16px;border:1px solid var(--border-color);border-radius:8px;cursor:pointer;font-size:14px;color:var(--text-secondary)">
                    <input type="radio" name="audience" value="7d"> Activos 7d ({{ active_7d }})
                </label>
                <label style="display:flex;align-items:center;gap:8px;padding:10px 16px;border:1px solid var(--border-color);border-radius:8px;cursor:pointer;font-size:14px;color:var(--text-secondary)">
                    <input type="radio" name="audience" value="30d"> Activos 30d ({{ active_30d }})
                </label>
            </div>
        </div>

        <div class="form-group" style="margin-bottom:20px">
            <label class="form-label">Mensaje</label>
            <textarea name="message" class="form-input" rows="6" placeholder="Escribe tu mensaje... Soporta HTML basico (<b>, <i>, <a>)" required></textarea>
        </div>

        <button type="submit" class="btn btn-primary" {% if not has_token %}disabled style="opacity:0.5"{% endif %}>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <path d="M22 2L11 13" />
                <path d="M22 2L15 22l-4-9-9-4z" />
            </svg>
            Enviar Mensaje
        </button>
    </form>
</div>
{% endblock %}
