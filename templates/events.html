{% extends "base.html" %}

{% block title %}Fiestas{% endblock %}
{% block header_title %}Gesti√≥n de Fiestas{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Fiestas y Eventos</h1>
        <p class="page-subtitle">Gestiona las fiestas que el chatbot muestra a los clientes ¬∑ Entradas v√≠a <strong
                style="color:var(--brand-green)">Elite Events App</strong></p>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a href="{{ url_for('events.export_csv') }}" class="btn btn-secondary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            CSV
        </a>
        <a href="{{ url_for('events.calendario') }}" class="btn btn-secondary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                <rect x="3" y="4" width="18" height="18" rx="2" /><path d="M16 2v4M8 2v4M3 10h18" />
            </svg>
            Calendario
        </a>
        {% if current_user and current_user.can_manage_events %}
        <button class="btn btn-primary" onclick="openModal('createModal')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            Anadir Fiesta
        </button>
        {% endif %}
    </div>
</div>

<!-- Filters -->
<form method="GET" action="{{ url_for('events.index') }}" class="toolbar">
    <div class="search-input">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <input type="text" name="search" placeholder="Buscar fiestas..." value="{{ search }}">
    </div>
    <select name="venue" class="filter-select" onchange="this.form.submit()">
        <option value="">Todas las salas</option>
        {% for v in venues %}
        <option value="{{ v }}" {% if selected_venue==v %}selected{% endif %}>{{ v }}</option>
        {% endfor %}
    </select>
    <select name="theme" class="filter-select" onchange="this.form.submit()">
        <option value="">Todas las tem√°ticas</option>
        {% for t in themes %}
        <option value="{{ t }}" {% if selected_theme==t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
    </select>
    <select name="status" class="filter-select" onchange="this.form.submit()">
        <option value="">Todos los estados</option>
        <option value="active" {% if selected_status=='active' %}selected{% endif %}>Activas</option>
        <option value="inactive" {% if selected_status=='inactive' %}selected{% endif %}>Inactivas</option>
    </select>
</form>

<!-- Events Table -->
<div class="card">
    {% if events %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Fecha</th>
                    <th>Sala</th>
                    <th>Tem√°tica</th>
                    <th>Entrada</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for event in events %}
                <tr>
                    <td>{{ event.name }}</td>
                    <td>{{ event.date.strftime('%d/%m/%Y %H:%M') if event.date else '‚Äî' }}</td>
                    <td>{{ event.venue }}</td>
                    <td><span class="badge badge-category">{{ event.theme }}</span></td>
                    <td>{{ event.entry_price if event.entry_price else '‚Äî' }}</td>
                    <td>
                        <span class="badge {% if event.active %}badge-active{% else %}badge-inactive{% endif %}">
                            {{ 'Activa' if event.active else 'Inactiva' }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="showAnalytics({{ event.id }}, {{ event.name | tojson }})" title="Analytics">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                    <path d="M18 20V10M12 20V4M6 20v-6" />
                                </svg>
                            </button>
                            {% if current_user and current_user.can_manage_events %}
                            <button class="btn btn-secondary btn-sm"
                                onclick='openEditModal({{ event.to_dict() | tojson }})'>Editar</button>
                            <form method="POST" action="{{ url_for('events.toggle', event_id=event.id) }}"
                                style="display:inline">
                                <button type="submit" class="btn btn-secondary btn-sm">
                                    {{ 'Desactivar' if event.active else 'Activar' }}
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('events.delete', event_id=event.id) }}"
                                style="display:inline" onsubmit="return confirm('¬øEliminar esta fiesta?')">
                                <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 2v4M16 2v4" />
            <rect x="3" y="4" width="18" height="18" rx="2" />
            <path d="M3 10h18" />
        </svg>
        <h3>No hay fiestas todav√≠a</h3>
        <p>Crea tu primera fiesta para que el chatbot pueda informar a los clientes</p>
    </div>
    {% endif %}
</div>

<!-- Create Modal -->
<div class="modal-overlay" id="createModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Nueva Fiesta</h3>
            <button class="modal-close" onclick="closeModal('createModal')">‚úï</button>
        </div>
        <form method="POST" action="{{ url_for('events.create') }}">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Nombre de la fiesta</label>
                    <input type="text" name="name" class="form-input" placeholder="Madness Halloween Edition" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha y Hora</label>
                    <input type="datetime-local" name="date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Sala</label>
                    <select name="venue" class="form-input" required>
                        <option value="">Seleccionar sala...</option>
                        {% for v in venues %}
                        <option value="{{ v }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tem√°tica</label>
                    <select name="theme" class="form-input">
                        {% for t in themes %}
                        <option value="{{ t }}">{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">DJs / Animaci√≥n</label>
                    <input type="text" name="dj_info" class="form-input" placeholder="DJ Neon, MC Light...">
                </div>
                <div class="form-group">
                    <label class="form-label">Aforo</label>
                    <input type="number" name="capacity" class="form-input" placeholder="500" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Precio entrada (referencia)</label>
                    <input type="text" name="entry_price" class="form-input" placeholder="8‚Ç¨ anticipada / 12‚Ç¨ taquilla">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea name="description" class="form-input" placeholder="Describe la fiesta para el chatbot..."
                        rows="3"></textarea>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">üéüÔ∏è Link de entradas (Elite Events App)</label>
                    <input type="text" name="entry_link" class="form-input"
                        placeholder="https://eliteevents.app/evento/...">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">URL de Imagen</label>
                    <input type="text" name="image_url" class="form-input" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label class="form-label">Visible para el Bot</label>
                    <div class="toggle-container">
                        <div class="toggle active" onclick="toggleSwitch(this)">
                            <input type="checkbox" name="active" checked style="display:none">
                            <span class="slider"></span>
                        </div>
                        <span style="font-size:13px;color:var(--text-secondary)">Activa</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createModal')">Cancelar</button>
                <button type="submit" class="btn btn-primary">Crear Fiesta</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Editar Fiesta</h3>
            <button class="modal-close" onclick="closeModal('editModal')">‚úï</button>
        </div>
        <form method="POST" id="editForm">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Nombre de la fiesta</label>
                    <input type="text" name="name" id="edit-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha y Hora</label>
                    <input type="datetime-local" name="date" id="edit-date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Sala</label>
                    <select name="venue" id="edit-venue" class="form-input" required>
                        {% for v in venues %}
                        <option value="{{ v }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tem√°tica</label>
                    <select name="theme" id="edit-theme" class="form-input">
                        {% for t in themes %}
                        <option value="{{ t }}">{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">DJs / Animaci√≥n</label>
                    <input type="text" name="dj_info" id="edit-dj_info" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Aforo</label>
                    <input type="number" name="capacity" id="edit-capacity" class="form-input" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Precio entrada (referencia)</label>
                    <input type="text" name="entry_price" id="edit-entry_price" class="form-input">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea name="description" id="edit-description" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">üéüÔ∏è Link de entradas (Elite Events App)</label>
                    <input type="text" name="entry_link" id="edit-entry_link" class="form-input">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">URL de Imagen</label>
                    <input type="text" name="image_url" id="edit-image_url" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Visible para el Bot</label>
                    <div class="toggle-container">
                        <div class="toggle" id="edit-toggle" onclick="toggleSwitch(this)">
                            <input type="checkbox" name="active" id="edit-active" style="display:none">
                            <span class="slider"></span>
                        </div>
                        <span style="font-size:13px;color:var(--text-secondary)">Activa</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>
<!-- Analytics Modal -->
<div class="modal-overlay" id="analyticsModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="analytics-title">Analytics</h3>
            <button class="modal-close" onclick="closeModal('analyticsModal')">&#10005;</button>
        </div>
        <div id="analytics-content" style="padding:20px">
            <div class="ai-loading">
                <div class="ai-loading-spinner"></div>
                <p>Cargando analytics...</p>
            </div>
        </div>
        <div style="height:200px;padding:0 20px 20px;display:none" id="analytics-chart-container">
            <canvas id="analyticsChart"></canvas>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleSwitch(el) {
        const cb = el.querySelector('input[type=checkbox]');
        cb.checked = !cb.checked;
        el.classList.toggle('active');
    }

    function openEditModal(event) {
        document.getElementById('editForm').action = '/events/' + event.id + '/update';
        document.getElementById('edit-name').value = event.name || '';
        document.getElementById('edit-venue').value = event.venue || '';
        document.getElementById('edit-theme').value = event.theme || 'Normal';
        document.getElementById('edit-dj_info').value = event.dj_info || '';
        document.getElementById('edit-capacity').value = event.capacity || 0;
        document.getElementById('edit-entry_price').value = event.entry_price || '';
        document.getElementById('edit-entry_link').value = event.entry_link || '';
        document.getElementById('edit-description').value = event.description || '';
        document.getElementById('edit-image_url').value = event.image_url || '';

        // Date format for datetime-local input
        if (event.date) {
            const d = new Date(event.date);
            const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
            document.getElementById('edit-date').value = local.toISOString().slice(0, 16);
        }

        // Toggle
        const toggle = document.getElementById('edit-toggle');
        const checkbox = document.getElementById('edit-active');
        if (event.active) {
            toggle.classList.add('active');
            checkbox.checked = true;
        } else {
            toggle.classList.remove('active');
            checkbox.checked = false;
        }

        openModal('editModal');
    }

    var analyticsChart = null;
    function showAnalytics(eventId, eventName) {
        document.getElementById('analytics-title').textContent = 'Analytics: ' + eventName;
        document.getElementById('analytics-content').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-tertiary)">Analizando menciones...</div>';
        document.getElementById('analytics-chart-container').style.display = 'none';
        openModal('analyticsModal');

        fetch('/events/' + eventId + '/analytics')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                document.getElementById('analytics-content').innerHTML =
                    '<div class="kpi-grid" style="grid-template-columns:1fr 1fr;margin-bottom:0">' +
                    '<div class="kpi-card kpi-accent-green" style="padding:16px">' +
                    '<div class="kpi-label">Menciones</div>' +
                    '<div class="kpi-value" style="font-size:24px">' + data.mention_count + '</div></div>' +
                    '<div class="kpi-card kpi-accent-cyan" style="padding:16px">' +
                    '<div class="kpi-label">Usuarios Unicos</div>' +
                    '<div class="kpi-value" style="font-size:24px">' + data.unique_users + '</div></div></div>';

                if (data.timeline.length > 0 && typeof Chart !== 'undefined') {
                    document.getElementById('analytics-chart-container').style.display = 'block';
                    if (analyticsChart) analyticsChart.destroy();
                    analyticsChart = new Chart(document.getElementById('analyticsChart'), {
                        type: 'bar',
                        data: {
                            labels: data.timeline.map(function(d) { return d.date.slice(5); }),
                            datasets: [{
                                label: 'Menciones',
                                data: data.timeline.map(function(d) { return d.count; }),
                                backgroundColor: 'rgba(57,255,20,0.3)',
                                borderColor: 'rgba(57,255,20,0.5)',
                                borderWidth: 1, borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { border:{display:false}, grid:{display:false}, ticks:{color:'rgba(255,255,255,0.4)',font:{size:11}} },
                                y: { border:{display:false}, grid:{color:'rgba(255,255,255,0.03)'}, beginAtZero:true, ticks:{stepSize:1,color:'rgba(255,255,255,0.4)'} }
                            }
                        }
                    });
                }
            })
            .catch(function() {
                document.getElementById('analytics-content').innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger)">Error al cargar analytics</div>';
            });
    }
</script>
{% endblock %}