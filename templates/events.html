{% extends "base.html" %}

{% block title %}Fiestas{% endblock %}
{% block header_title %}Gesti√≥n de Fiestas{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Fiestas y Eventos</h1>
        <p class="page-subtitle">Gestiona las fiestas que el chatbot muestra a los clientes ¬∑ Entradas v√≠a <strong
                style="color:var(--brand-green)">Elite Events App</strong></p>
    </div>
    <button class="btn btn-primary" onclick="openModal('createModal')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
        A√±adir Fiesta
    </button>
</div>

<!-- Filters -->
<form method="GET" action="{{ url_for('events.index') }}" class="toolbar">
    <div class="search-input">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </svg>
        <input type="text" name="search" placeholder="Buscar fiestas..." value="{{ search }}">
    </div>
    <select name="venue" class="filter-select" onchange="this.form.submit()">
        <option value="">Todas las salas</option>
        {% for v in venues %}
        <option value="{{ v }}" {% if selected_venue==v %}selected{% endif %}>{{ v }}</option>
        {% endfor %}
    </select>
    <select name="theme" class="filter-select" onchange="this.form.submit()">
        <option value="">Todas las tem√°ticas</option>
        {% for t in themes %}
        <option value="{{ t }}" {% if selected_theme==t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
    </select>
    <select name="status" class="filter-select" onchange="this.form.submit()">
        <option value="">Todos los estados</option>
        <option value="active" {% if selected_status=='active' %}selected{% endif %}>Activas</option>
        <option value="inactive" {% if selected_status=='inactive' %}selected{% endif %}>Inactivas</option>
    </select>
</form>

<!-- Events Table -->
<div class="card">
    {% if events %}
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Fecha</th>
                    <th>Sala</th>
                    <th>Tem√°tica</th>
                    <th>Entrada</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for event in events %}
                <tr>
                    <td>{{ event.name }}</td>
                    <td>{{ event.date.strftime('%d/%m/%Y %H:%M') if event.date else '‚Äî' }}</td>
                    <td>{{ event.venue }}</td>
                    <td><span class="badge badge-category">{{ event.theme }}</span></td>
                    <td>{{ event.entry_price if event.entry_price else '‚Äî' }}</td>
                    <td>
                        <span class="badge {% if event.active %}badge-active{% else %}badge-inactive{% endif %}">
                            {{ 'Activa' if event.active else 'Inactiva' }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm"
                                onclick='openEditModal({{ event.to_dict() | tojson }})'>Editar</button>
                            <form method="POST" action="{{ url_for('events.toggle', event_id=event.id) }}"
                                style="display:inline">
                                <button type="submit" class="btn btn-secondary btn-sm">
                                    {{ 'Desactivar' if event.active else 'Activar' }}
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('events.delete', event_id=event.id) }}"
                                style="display:inline" onsubmit="return confirm('¬øEliminar esta fiesta?')">
                                <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 2v4M16 2v4" />
            <rect x="3" y="4" width="18" height="18" rx="2" />
            <path d="M3 10h18" />
        </svg>
        <h3>No hay fiestas todav√≠a</h3>
        <p>Crea tu primera fiesta para que el chatbot pueda informar a los clientes</p>
    </div>
    {% endif %}
</div>

<!-- Create Modal -->
<div class="modal-overlay" id="createModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Nueva Fiesta</h3>
            <button class="modal-close" onclick="closeModal('createModal')">‚úï</button>
        </div>
        <form method="POST" action="{{ url_for('events.create') }}">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Nombre de la fiesta</label>
                    <input type="text" name="name" class="form-input" placeholder="Madness Halloween Edition" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha y Hora</label>
                    <input type="datetime-local" name="date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Sala</label>
                    <select name="venue" class="form-input" required>
                        <option value="">Seleccionar sala...</option>
                        {% for v in venues %}
                        <option value="{{ v }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tem√°tica</label>
                    <select name="theme" class="form-input">
                        {% for t in themes %}
                        <option value="{{ t }}">{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">DJs / Animaci√≥n</label>
                    <input type="text" name="dj_info" class="form-input" placeholder="DJ Neon, MC Light...">
                </div>
                <div class="form-group">
                    <label class="form-label">Aforo</label>
                    <input type="number" name="capacity" class="form-input" placeholder="500" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Precio entrada (referencia)</label>
                    <input type="text" name="entry_price" class="form-input" placeholder="8‚Ç¨ anticipada / 12‚Ç¨ taquilla">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea name="description" class="form-input" placeholder="Describe la fiesta para el chatbot..."
                        rows="3"></textarea>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">üéüÔ∏è Link de entradas (Elite Events App)</label>
                    <input type="text" name="entry_link" class="form-input"
                        placeholder="https://eliteevents.app/evento/...">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">URL de Imagen</label>
                    <input type="text" name="image_url" class="form-input" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label class="form-label">Visible para el Bot</label>
                    <div class="toggle-container">
                        <div class="toggle active" onclick="toggleSwitch(this)">
                            <input type="checkbox" name="active" checked style="display:none">
                            <span class="slider"></span>
                        </div>
                        <span style="font-size:13px;color:var(--text-secondary)">Activa</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('createModal')">Cancelar</button>
                <button type="submit" class="btn btn-primary">Crear Fiesta</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Editar Fiesta</h3>
            <button class="modal-close" onclick="closeModal('editModal')">‚úï</button>
        </div>
        <form method="POST" id="editForm">
            <div class="form-grid">
                <div class="form-group full-width">
                    <label class="form-label">Nombre de la fiesta</label>
                    <input type="text" name="name" id="edit-name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha y Hora</label>
                    <input type="datetime-local" name="date" id="edit-date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Sala</label>
                    <select name="venue" id="edit-venue" class="form-input" required>
                        {% for v in venues %}
                        <option value="{{ v }}">{{ v }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tem√°tica</label>
                    <select name="theme" id="edit-theme" class="form-input">
                        {% for t in themes %}
                        <option value="{{ t }}">{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">DJs / Animaci√≥n</label>
                    <input type="text" name="dj_info" id="edit-dj_info" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Aforo</label>
                    <input type="number" name="capacity" id="edit-capacity" class="form-input" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Precio entrada (referencia)</label>
                    <input type="text" name="entry_price" id="edit-entry_price" class="form-input">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea name="description" id="edit-description" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group full-width">
                    <label class="form-label">üéüÔ∏è Link de entradas (Elite Events App)</label>
                    <input type="text" name="entry_link" id="edit-entry_link" class="form-input">
                </div>
                <div class="form-group full-width">
                    <label class="form-label">URL de Imagen</label>
                    <input type="text" name="image_url" id="edit-image_url" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Visible para el Bot</label>
                    <div class="toggle-container">
                        <div class="toggle" id="edit-toggle" onclick="toggleSwitch(this)">
                            <input type="checkbox" name="active" id="edit-active" style="display:none">
                            <span class="slider"></span>
                        </div>
                        <span style="font-size:13px;color:var(--text-secondary)">Activa</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editModal')">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleSwitch(el) {
        const cb = el.querySelector('input[type=checkbox]');
        cb.checked = !cb.checked;
        el.classList.toggle('active');
    }

    function openEditModal(event) {
        document.getElementById('editForm').action = '/events/' + event.id + '/update';
        document.getElementById('edit-name').value = event.name || '';
        document.getElementById('edit-venue').value = event.venue || '';
        document.getElementById('edit-theme').value = event.theme || 'Normal';
        document.getElementById('edit-dj_info').value = event.dj_info || '';
        document.getElementById('edit-capacity').value = event.capacity || 0;
        document.getElementById('edit-entry_price').value = event.entry_price || '';
        document.getElementById('edit-entry_link').value = event.entry_link || '';
        document.getElementById('edit-description').value = event.description || '';
        document.getElementById('edit-image_url').value = event.image_url || '';

        // Date format for datetime-local input
        if (event.date) {
            const d = new Date(event.date);
            const local = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
            document.getElementById('edit-date').value = local.toISOString().slice(0, 16);
        }

        // Toggle
        const toggle = document.getElementById('edit-toggle');
        const checkbox = document.getElementById('edit-active');
        if (event.active) {
            toggle.classList.add('active');
            checkbox.checked = true;
        } else {
            toggle.classList.remove('active');
            checkbox.checked = false;
        }

        openModal('editModal');
    }
</script>
{% endblock %}