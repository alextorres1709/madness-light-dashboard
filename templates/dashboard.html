{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}
{% block header_title %}Dashboard{% endblock %}

{% block content %}
<!-- Welcome Banner -->
<div class="welcome-banner animate-in">
    <div class="welcome-title">Bienvenido a <span>Madness Light</span></div>
    <div class="welcome-subtitle">Panel de control del agente de IA y gesti칩n de fiestas. Aqu칤 puedes ver las
        estad칤sticas de uso y gestionar los eventos.</div>
</div>

<!-- KPI Cards -->
<div class="kpi-grid">
    <div class="kpi-card kpi-accent-green animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
            </svg>
        </div>
        <div class="kpi-label">Mensajes Hoy</div>
        <div class="kpi-value">{{ messages_today }}</div>
        <div class="kpi-subtitle">conversaciones del agente</div>
    </div>

    <div class="kpi-card kpi-accent-cyan animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" />
                <path d="M16 2v4M8 2v4M3 10h18" />
            </svg>
        </div>
        <div class="kpi-label">Esta Semana</div>
        <div class="kpi-value">{{ messages_week }}</div>
        <div class="kpi-subtitle">mensajes recibidos</div>
    </div>

    <div class="kpi-card kpi-accent-purple animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20V10M18 20V4M6 20v-4" />
            </svg>
        </div>
        <div class="kpi-label">Este Mes</div>
        <div class="kpi-value">{{ messages_month }}</div>
        <div class="kpi-subtitle">crecimiento mensual</div>
    </div>

    <div class="kpi-card kpi-accent-amber animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 2v4M16 2v4" />
                <rect x="3" y="4" width="18" height="18" rx="2" />
                <path d="M3 10h18" />
            </svg>
        </div>
        <div class="kpi-label">Fiestas Activas</div>
        <div class="kpi-value">{{ active_events }}</div>
        <div class="kpi-subtitle">de {{ total_events }} totales</div>
    </div>

    <div class="kpi-card animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M23 21v-2a4 4 0 00-3-3.87" />
                <path d="M16 3.13a4 4 0 010 7.75" />
            </svg>
        </div>
        <div class="kpi-label">Total Mensajes</div>
        <div class="kpi-value">{{ messages_total }}</div>
        <div class="kpi-subtitle">desde siempre</div>
    </div>
</div>

<!-- Quick Actions -->
<div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
    </svg>
    <h2>Acciones R치pidas</h2>
</div>
<div class="quick-actions" style="grid-template-columns:repeat(4, 1fr)">
    <a href="{{ url_for('events.index') }}" class="quick-action-card">
        <div class="quick-action-icon green">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
        </div>
        <div>
            <div class="quick-action-text">Crear Fiesta</div>
            <div class="quick-action-desc">A침ade un nuevo evento</div>
        </div>
    </a>
    <a href="{{ url_for('stats.index') }}" class="quick-action-card">
        <div class="quick-action-icon purple">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 20V10M12 20V4M6 20v-6" />
            </svg>
        </div>
        <div>
            <div class="quick-action-text">Ver Estad칤sticas</div>
            <div class="quick-action-desc">An치lisis detallado</div>
        </div>
    </a>
    <a href="{{ url_for('agent.index') }}" class="quick-action-card">
        <div class="quick-action-icon amber">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2a4 4 0 014 4v1a1 1 0 001 1h1a4 4 0 010 8h-1a1 1 0 00-1 1v1a4 4 0 01-8 0v-1a1 1 0 00-1-1H6a4 4 0 010-8h1a1 1 0 001-1V6a4 4 0 014-4z" />
            </svg>
        </div>
        <div>
            <div class="quick-action-text">Agente de IA</div>
            <div class="quick-action-desc">Conversaciones y estado</div>
        </div>
    </a>
    <a href="{{ url_for('settings.index') }}" class="quick-action-card">
        <div class="quick-action-icon cyan">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3" />
                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06" />
            </svg>
        </div>
        <div>
            <div class="quick-action-text">Ajustes</div>
            <div class="quick-action-desc">Info de la empresa</div>
        </div>
    </a>
</div>

<!-- Charts Row -->
<div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 20V10M12 20V4M6 20v-6" />
    </svg>
    <h2>Estad칤sticas del Agente de IA</h2>
</div>
<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                </svg>
                Mensajes por D칤a (30 d칤as)
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                </svg>
                Mensajes por Hora
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>
</div>

<!-- Bottom Section: Upcoming Events + Recent Messages -->
<div class="grid-3">
    <!-- Recent Messages -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
                </svg>
                Mensajes Recientes
            </h3>
            <span class="badge badge-platform">{{ messages_total }} total</span>
        </div>

        {% if recent_messages %}
        <div class="messages-list">
            {% for msg in recent_messages[:10] %}
            <div class="message-item">
                <div class="message-avatar">{{ msg.user_id[:1] | upper }}</div>
                <div class="message-body">
                    <div class="message-header">
                        <span class="message-user">Usuario {{ msg.user_id[-4:] }}</span>
                        <span class="badge badge-platform">Telegram</span>
                        <span class="message-time">{{ msg.created_at.strftime('%d/%m %H:%M') if msg.created_at else ''
                            }}</span>
                    </div>
                    <div class="message-text">{{ msg.content[:150] }}{{ '...' if msg.content|length > 150 else '' }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
            </svg>
            <h3>No hay mensajes todav칤a</h3>
            <p>Los mensajes aparecer치n cuando el agente de IA empiece a funcionar</p>
        </div>
        {% endif %}
    </div>

    <!-- Upcoming Events -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 2v4M16 2v4" />
                    <rect x="3" y="4" width="18" height="18" rx="2" />
                    <path d="M3 10h18" />
                </svg>
                Pr칩ximas Fiestas
            </h3>
        </div>

        {% if upcoming_events %}
        <div class="upcoming-events">
            {% for event in upcoming_events %}
            <div class="upcoming-event-card">
                <div class="upcoming-event-date">
                    <div class="day">{{ event.date.strftime('%d') }}</div>
                    <div class="month">{{ event.date.strftime('%b') }}</div>
                </div>
                <div class="upcoming-event-info">
                    <div class="upcoming-event-name">{{ event.name }}</div>
                    <div class="upcoming-event-meta">
                        游늸 {{ event.venue }} 췅 <span class="badge badge-theme" style="padding:2px 6px;font-size:10px">{{
                            event.theme }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 2v4M16 2v4" />
                <rect x="3" y="4" width="18" height="18" rx="2" />
                <path d="M3 10h18" />
            </svg>
            <h3>Sin fiestas pr칩ximas</h3>
            <p>Crea nuevas fiestas desde la secci칩n Fiestas</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Chart.js configuration
    Chart.defaults.color = 'rgba(255,255,255,0.35)';
    Chart.defaults.font.family = 'Inter';

    // Daily messages chart
    const dailyData = {{ daily_messages | tojson }};
    new Chart(document.getElementById('dailyChart'), {
        type: 'line',
        data: {
            labels: dailyData.map(d => d.date),
            datasets: [{
                label: 'Mensajes',
                data: dailyData.map(d => d.count),
                borderColor: '#39FF14',
                backgroundColor: (ctx) => {
                    const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 280);
                    gradient.addColorStop(0, 'rgba(57, 255, 20, 0.15)');
                    gradient.addColorStop(1, 'rgba(57, 255, 20, 0.0)');
                    return gradient;
                },
                fill: true,
                tension: 0.4,
                borderWidth: 2,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#39FF14',
                pointHoverBorderColor: '#000',
                pointHoverBorderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(10,10,15,0.95)', borderColor: 'rgba(57,255,20,0.2)', borderWidth: 1, padding: 12, cornerRadius: 8, titleFont: { weight: 700 } } },
            scales: {
                x: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { maxTicksLimit: 10, font: { size: 11 } } },
                y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } } }
            }
        }
    });

    // Hourly messages chart
    const hourlyData = {{ hourly_messages | tojson }};
    new Chart(document.getElementById('hourlyChart'), {
        type: 'bar',
        data: {
            labels: hourlyData.map(d => d.hour),
            datasets: [{
                label: 'Mensajes',
                data: hourlyData.map(d => d.count),
                backgroundColor: (ctx) => {
                    const gradient = ctx.chart.ctx.createLinearGradient(0, 280, 0, 0);
                    gradient.addColorStop(0, 'rgba(6, 182, 212, 0.05)');
                    gradient.addColorStop(1, 'rgba(6, 182, 212, 0.35)');
                    return gradient;
                },
                borderColor: 'rgba(6, 182, 212, 0.5)',
                borderWidth: 1,
                borderRadius: 6,
                hoverBackgroundColor: 'rgba(6, 182, 212, 0.5)',
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(10,10,15,0.95)', borderColor: 'rgba(6,182,212,0.2)', borderWidth: 1, padding: 12, cornerRadius: 8 } },
            scales: {
                x: { grid: { display: false }, ticks: { maxTicksLimit: 12, font: { size: 11 } } },
                y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } } }
            }
        }
    });
</script>
{% endblock %}