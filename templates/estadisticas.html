{% extends "base.html" %}

{% block title %}Estadísticas{% endblock %}
{% block header_title %}Estadísticas{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Estadísticas</h1>
        <p class="page-subtitle">Análisis completo del rendimiento del agente de IA y el engagement de los usuarios</p>
    </div>
</div>

<!-- KPI Cards -->
<div class="kpi-grid">
    <div class="kpi-card kpi-accent-green animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
            </svg>
        </div>
        <div class="kpi-label">Mensajes Hoy</div>
        <div class="kpi-value">{{ messages_today }}</div>
    </div>

    <div class="kpi-card kpi-accent-cyan animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" />
                <path d="M16 2v4M8 2v4M3 10h18" />
            </svg>
        </div>
        <div class="kpi-label">Esta Semana</div>
        <div class="kpi-value">{{ messages_week }}</div>
    </div>

    <div class="kpi-card kpi-accent-purple animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20V10M18 20V4M6 20v-4" />
            </svg>
        </div>
        <div class="kpi-label">Este Mes</div>
        <div class="kpi-value">{{ messages_month }}</div>
    </div>

    <div class="kpi-card kpi-accent-amber animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                <circle cx="9" cy="7" r="4" />
            </svg>
        </div>
        <div class="kpi-label">Usuarios Únicos</div>
        <div class="kpi-value">{{ unique_users }}</div>
    </div>

    <div class="kpi-card animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" />
                <line x1="4" y1="22" x2="4" y2="15" />
            </svg>
        </div>
        <div class="kpi-label">Total Mensajes</div>
        <div class="kpi-value">{{ messages_total }}</div>
    </div>
</div>

<!-- Charts -->
<div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 20V10M12 20V4M6 20v-6" />
    </svg>
    <h2>Tendencias</h2>
</div>
<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                </svg>
                Mensajes por Día (30 días)
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                </svg>
                Actividad por Hora
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>
</div>

<!-- Bottom section: Platforms + Top Users -->
<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="3" width="20" height="14" rx="2" />
                    <line x1="8" y1="21" x2="16" y2="21" />
                    <line x1="12" y1="17" x2="12" y2="21" />
                </svg>
                Plataformas
            </h3>
        </div>
        {% if platform_data %}
        <div class="chart-container" style="height:200px">
            <canvas id="platformChart"></canvas>
        </div>
        {% else %}
        <div class="empty-state" style="padding:30px">
            <h3>Sin datos de plataformas</h3>
            <p>Aparecerán cuando el agente de IA empiece a recibir mensajes</p>
        </div>
        {% endif %}
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M23 21v-2a4 4 0 00-3-3.87" />
                    <path d="M16 3.13a4 4 0 010 7.75" />
                </svg>
                Top Usuarios
            </h3>
        </div>
        {% if top_users_data %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Usuario</th>
                        <th>Mensajes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in top_users_data %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ user.name }}</td>
                        <td><span class="badge badge-platform">{{ user.count }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state" style="padding:30px">
            <h3>Sin usuarios aún</h3>
            <p>Los usuarios aparecerán cuando empiecen a interactuar</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    Chart.defaults.color = 'rgba(255,255,255,0.35)';
    Chart.defaults.font.family = 'Inter';

    // Daily chart
    const dailyData = {{ daily_messages | tojson }};
    new Chart(document.getElementById('dailyChart'), {
        type: 'line',
        data: {
            labels: dailyData.map(d => d.date),
            datasets: [{
                label: 'Mensajes',
                data: dailyData.map(d => d.count),
                borderColor: '#39FF14',
                backgroundColor: (ctx) => {
                    const g = ctx.chart.ctx.createLinearGradient(0, 0, 0, 280);
                    g.addColorStop(0, 'rgba(57, 255, 20, 0.15)');
                    g.addColorStop(1, 'rgba(57, 255, 20, 0.0)');
                    return g;
                },
                fill: true, tension: 0.4, borderWidth: 2,
                pointRadius: 0, pointHoverRadius: 6,
                pointHoverBackgroundColor: '#39FF14',
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(10,10,15,0.95)', borderColor: 'rgba(57,255,20,0.2)', borderWidth: 1, padding: 12, cornerRadius: 8 } },
            scales: {
                x: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { maxTicksLimit: 10, font: { size: 11 } } },
                y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } } }
            }
        }
    });

    // Hourly chart
    const hourlyData = {{ hourly_messages | tojson }};
    new Chart(document.getElementById('hourlyChart'), {
        type: 'bar',
        data: {
            labels: hourlyData.map(d => d.hour),
            datasets: [{
                label: 'Mensajes',
                data: hourlyData.map(d => d.count),
                backgroundColor: (ctx) => {
                    const g = ctx.chart.ctx.createLinearGradient(0, 280, 0, 0);
                    g.addColorStop(0, 'rgba(168, 85, 247, 0.05)');
                    g.addColorStop(1, 'rgba(168, 85, 247, 0.35)');
                    return g;
                },
                borderColor: 'rgba(168, 85, 247, 0.5)',
                borderWidth: 1, borderRadius: 6,
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(10,10,15,0.95)', borderColor: 'rgba(168,85,247,0.2)', borderWidth: 1, padding: 12, cornerRadius: 8 } },
            scales: {
                x: { grid: { display: false }, ticks: { maxTicksLimit: 12, font: { size: 11 } } },
                y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } } }
            }
        }
    });

    // Platform chart
    {% if platform_data %}
    const platformData = {{ platform_data | tojson }};
    new Chart(document.getElementById('platformChart'), {
        type: 'doughnut',
        data: {
            labels: platformData.map(d => d.platform),
            datasets: [{
                data: platformData.map(d => d.count),
                backgroundColor: ['rgba(57,255,20,0.6)', 'rgba(6,182,212,0.6)', 'rgba(168,85,247,0.6)', 'rgba(245,158,11,0.6)'],
                borderColor: 'rgba(10,10,15,0.8)',
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { padding: 16, usePointStyle: true, pointStyle: 'circle', font: { size: 12 } } } },
            cutout: '65%',
        }
    });
    {% endif %}
</script>
{% endblock %}