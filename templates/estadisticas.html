{% extends "base.html" %}

{% block title %}Estadísticas{% endblock %}
{% block header_title %}Estadísticas{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Estadísticas</h1>
        <p class="page-subtitle">Métricas de usuarios, eventos y rendimiento del agente</p>
    </div>
    <a href="{{ url_for('stats.export_csv') }}" class="btn btn-secondary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
        </svg>
        Exportar CSV
    </a>
</div>

<!-- KPI Cards -->
<div class="kpi-grid">
    <div class="kpi-card kpi-accent-green animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M23 21v-2a4 4 0 00-3-3.87" />
                <path d="M16 3.13a4 4 0 010 7.75" />
            </svg>
        </div>
        <div class="kpi-label">Usuarios Este Mes</div>
        <div class="kpi-value">{{ users_this_month }}</div>
        <div class="kpi-subtitle">
            {% if user_growth > 0 %}
            <span style="color:#39FF14">+{{ user_growth }}%</span> vs mes anterior
            {% elif user_growth < 0 %}
            <span style="color:#ef4444">{{ user_growth }}%</span> vs mes anterior
            {% else %}
            sin cambio vs mes anterior
            {% endif %}
        </div>
    </div>

    <div class="kpi-card kpi-accent-cyan animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                <circle cx="8.5" cy="7" r="4" />
            </svg>
        </div>
        <div class="kpi-label">Usuarios Totales</div>
        <div class="kpi-value">{{ total_users }}</div>
        <div class="kpi-subtitle">desde siempre</div>
    </div>

    <div class="kpi-card kpi-accent-purple animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
            </svg>
        </div>
        <div class="kpi-label">Media Msg/Usuario</div>
        <div class="kpi-value">{{ avg_per_user }}</div>
        <div class="kpi-subtitle">{{ total_messages }} mensajes totales</div>
    </div>

    <div class="kpi-card kpi-accent-amber animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
            </svg>
        </div>
        <div class="kpi-label">Hora Pico</div>
        <div class="kpi-value" style="font-size:28px">{{ peak_hour }}</div>
        <div class="kpi-subtitle">mayor actividad de usuarios</div>
    </div>

    <div class="kpi-card animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M8 2v4M16 2v4" />
                <rect x="3" y="4" width="18" height="18" rx="2" />
                <path d="M3 10h18" />
            </svg>
        </div>
        <div class="kpi-label">Eventos</div>
        <div class="kpi-value">{{ total_events }}</div>
        <div class="kpi-subtitle">{{ upcoming_events }} próximamente</div>
    </div>
</div>

<!-- Charts Row 1: Users + Hourly -->
<div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
        <circle cx="9" cy="7" r="4" />
        <path d="M23 21v-2a4 4 0 00-3-3.87" />
        <path d="M16 3.13a4 4 0 010 7.75" />
    </svg>
    <h2>Usuarios y Actividad</h2>
</div>
<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                    <polyline points="17 6 23 6 23 12" />
                </svg>
                Usuarios Activos por Semana
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="weeklyUsersChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                </svg>
                Actividad por Hora
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>
</div>

<!-- Charts Row 2: Venues + Themes -->
{% if venues_data or themes_data %}
<div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M8 2v4M16 2v4" />
        <rect x="3" y="4" width="18" height="18" rx="2" />
        <path d="M3 10h18" />
    </svg>
    <h2>Eventos</h2>
</div>
<div class="grid-2">
    {% if venues_data %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" />
                    <circle cx="12" cy="10" r="3" />
                </svg>
                Eventos por Sala
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="venuesChart"></canvas>
        </div>
    </div>
    {% endif %}

    {% if themes_data %}
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <path d="M12 2a14.5 14.5 0 000 20 14.5 14.5 0 000-20" />
                    <path d="M2 12h20" />
                </svg>
                Distribución por Temática
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="themesChart"></canvas>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Bottom: Top Users + Upcoming Events -->
<div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 20V10M12 20V4M6 20v-6" />
    </svg>
    <h2>Detalle</h2>
</div>
<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M23 21v-2a4 4 0 00-3-3.87" />
                    <path d="M16 3.13a4 4 0 010 7.75" />
                </svg>
                Usuarios Más Activos
            </h3>
        </div>
        {% if top_users_data %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Usuario</th>
                        <th>Mensajes</th>
                        <th>Días activo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in top_users_data %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>Usuario {{ user.name[-4:] }}</td>
                        <td><span class="badge badge-platform">{{ user.messages }}</span></td>
                        <td>{{ user.days }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state" style="padding:30px">
            <h3>Sin usuarios aún</h3>
            <p>Los usuarios aparecerán cuando empiecen a interactuar</p>
        </div>
        {% endif %}
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M8 2v4M16 2v4" />
                    <rect x="3" y="4" width="18" height="18" rx="2" />
                    <path d="M3 10h18" />
                </svg>
                Próximos Eventos
            </h3>
        </div>
        {% if next_events %}
        <div class="upcoming-events">
            {% for event in next_events %}
            <div class="upcoming-event-card">
                <div class="upcoming-event-date">
                    <div class="day">{{ event.date.strftime('%d') }}</div>
                    <div class="month">{{ event.date.strftime('%b') }}</div>
                </div>
                <div class="upcoming-event-info">
                    <div class="upcoming-event-name">{{ event.name }}</div>
                    <div class="upcoming-event-meta">
                        {{ event.venue }} · <span class="badge badge-theme"
                            style="padding:2px 6px;font-size:10px">{{ event.theme }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state" style="padding:30px">
            <h3>Sin eventos próximos</h3>
            <p>Crea nuevas fiestas desde la sección Fiestas</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- AI Insights Section -->
<div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a4 4 0 014 4v1a1 1 0 001 1h1a4 4 0 010 8h-1a1 1 0 00-1 1v1a4 4 0 01-8 0v-1a1 1 0 00-1-1H6a4 4 0 010-8h1a1 1 0 001-1V6a4 4 0 014-4z" />
    </svg>
    <h2>Análisis IA</h2>
</div>
<div id="ai-insights-container">
    <div class="ai-loading">
        <div class="ai-loading-spinner"></div>
        <p>Analizando conversaciones con IA...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    if (typeof Chart === 'undefined') {
        document.querySelectorAll('.chart-container').forEach(c => {
            c.innerHTML = '<p style="color:var(--text-secondary);padding:20px;text-align:center">Error al cargar las gráficas. Recarga la página.</p>';
        });
    } else {
        Chart.defaults.color = 'rgba(255,255,255,0.35)';
        Chart.defaults.font.family = 'Inter';

        const chartScales = (opts = {}) => ({
            x: { border: { display: false }, grid: { color: 'rgba(255,255,255,0.03)', ...opts.xGrid }, ticks: { font: { size: 11 }, ...opts.xTicks } },
            y: { border: { display: false }, grid: { color: 'rgba(255,255,255,0.03)' }, beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } } }
        });
        const chartTooltip = (color) => ({
            backgroundColor: 'rgba(10,10,15,0.95)',
            borderColor: color, borderWidth: 1,
            padding: 12, cornerRadius: 8
        });

        // Weekly users chart
        const weeklyData = {{ weekly_users | tojson }};
        new Chart(document.getElementById('weeklyUsersChart'), {
            type: 'bar',
            data: {
                labels: weeklyData.map(d => d.week),
                datasets: [{
                    label: 'Usuarios',
                    data: weeklyData.map(d => d.count),
                    backgroundColor: (ctx) => {
                        const g = ctx.chart.ctx.createLinearGradient(0, 280, 0, 0);
                        g.addColorStop(0, 'rgba(57, 255, 20, 0.05)');
                        g.addColorStop(1, 'rgba(57, 255, 20, 0.35)');
                        return g;
                    },
                    borderColor: 'rgba(57, 255, 20, 0.5)',
                    borderWidth: 1, borderRadius: 6,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: chartTooltip('rgba(57,255,20,0.2)') },
                scales: chartScales()
            }
        });

        // Hourly activity chart
        const hourlyData = {{ hourly_messages | tojson }};
        new Chart(document.getElementById('hourlyChart'), {
            type: 'bar',
            data: {
                labels: hourlyData.map(d => d.hour),
                datasets: [{
                    label: 'Mensajes',
                    data: hourlyData.map(d => d.count),
                    backgroundColor: (ctx) => {
                        const g = ctx.chart.ctx.createLinearGradient(0, 280, 0, 0);
                        g.addColorStop(0, 'rgba(168, 85, 247, 0.05)');
                        g.addColorStop(1, 'rgba(168, 85, 247, 0.35)');
                        return g;
                    },
                    borderColor: 'rgba(168, 85, 247, 0.5)',
                    borderWidth: 1, borderRadius: 6,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: chartTooltip('rgba(168,85,247,0.2)') },
                scales: chartScales({ xGrid: { display: false }, xTicks: { maxTicksLimit: 12 } })
            }
        });

        {% if venues_data %}
        // Venues chart
        const venuesData = {{ venues_data | tojson }};
        new Chart(document.getElementById('venuesChart'), {
            type: 'bar',
            data: {
                labels: venuesData.map(d => d.venue.split('(')[0].trim()),
                datasets: [{
                    label: 'Eventos',
                    data: venuesData.map(d => d.count),
                    backgroundColor: (ctx) => {
                        const g = ctx.chart.ctx.createLinearGradient(0, 280, 0, 0);
                        g.addColorStop(0, 'rgba(6, 182, 212, 0.05)');
                        g.addColorStop(1, 'rgba(6, 182, 212, 0.35)');
                        return g;
                    },
                    borderColor: 'rgba(6, 182, 212, 0.5)',
                    borderWidth: 1, borderRadius: 6,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { legend: { display: false }, tooltip: chartTooltip('rgba(6,182,212,0.2)') },
                scales: {
                    x: { border: { display: false }, grid: { color: 'rgba(255,255,255,0.03)' }, beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } } },
                    y: { border: { display: false }, grid: { display: false }, ticks: { font: { size: 11 } } }
                }
            }
        });
        {% endif %}

        {% if themes_data %}
        // Themes doughnut chart
        const themesData = {{ themes_data | tojson }};
        const themeColors = ['rgba(57,255,20,0.6)', 'rgba(6,182,212,0.6)', 'rgba(168,85,247,0.6)', 'rgba(245,158,11,0.6)', 'rgba(239,68,68,0.6)', 'rgba(99,102,241,0.6)', 'rgba(236,72,153,0.6)', 'rgba(107,114,128,0.6)'];
        new Chart(document.getElementById('themesChart'), {
            type: 'doughnut',
            data: {
                labels: themesData.map(d => d.theme),
                datasets: [{
                    data: themesData.map(d => d.count),
                    backgroundColor: themeColors.slice(0, themesData.length),
                    borderColor: 'rgba(10,10,15,0.8)',
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: { position: 'right', labels: { padding: 16, usePointStyle: true, pointStyle: 'circle', font: { size: 12 } } },
                    tooltip: chartTooltip('rgba(168,85,247,0.2)')
                }
            }
        });
        {% endif %}
    }

    // AI Insights
    fetch('/estadisticas/insights')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('ai-insights-container');
            if (data.error) {
                container.innerHTML = '<div class="ai-error"><p>No se pudo generar el análisis: ' + data.error + '</p></div>';
                return;
            }
            container.innerHTML = `
                <div class="ai-insights-grid">
                    <div class="ai-insight-card ai-accent-green">
                        <div class="ai-insight-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></div>
                        <h3>Preguntas Frecuentes</h3>
                        <div class="ai-insight-content">${data.preguntas_frecuentes || 'Sin datos suficientes'}</div>
                    </div>
                    <div class="ai-insight-card ai-accent-cyan">
                        <div class="ai-insight-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
                        <h3>Salas Populares</h3>
                        <div class="ai-insight-content">${data.salas_populares || 'Sin datos suficientes'}</div>
                    </div>
                    <div class="ai-insight-card ai-accent-purple">
                        <div class="ai-insight-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></div>
                        <h3>Sentimiento General</h3>
                        <div class="ai-insight-content">${data.sentimiento || 'Sin datos suficientes'}</div>
                    </div>
                    <div class="ai-insight-card ai-accent-amber">
                        <div class="ai-insight-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></div>
                        <h3>Sugerencias de Mejora</h3>
                        <div class="ai-insight-content">${data.sugerencias || 'Sin datos suficientes'}</div>
                    </div>
                </div>
            `;
        })
        .catch(() => {
            document.getElementById('ai-insights-container').innerHTML =
                '<div class="ai-error"><p>Error al conectar con el servicio de IA</p></div>';
        });
</script>
{% endblock %}
