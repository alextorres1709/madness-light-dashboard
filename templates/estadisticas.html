{% extends "base.html" %}

{% block title %}Estadísticas{% endblock %}
{% block header_title %}Estadísticas{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Estadísticas</h1>
        <p class="page-subtitle">Análisis completo del rendimiento del agente de IA y el engagement de los usuarios</p>
    </div>
</div>

<!-- KPI Cards -->
<div class="kpi-grid">
    <div class="kpi-card kpi-accent-green animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" />
            </svg>
        </div>
        <div class="kpi-label">Mensajes Hoy</div>
        <div class="kpi-value">{{ messages_today }}</div>
    </div>

    <div class="kpi-card kpi-accent-cyan animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" />
                <path d="M16 2v4M8 2v4M3 10h18" />
            </svg>
        </div>
        <div class="kpi-label">Esta Semana</div>
        <div class="kpi-value">{{ messages_week }}</div>
    </div>

    <div class="kpi-card kpi-accent-purple animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20V10M18 20V4M6 20v-4" />
            </svg>
        </div>
        <div class="kpi-label">Este Mes</div>
        <div class="kpi-value">{{ messages_month }}</div>
    </div>

    <div class="kpi-card kpi-accent-amber animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                <circle cx="9" cy="7" r="4" />
            </svg>
        </div>
        <div class="kpi-label">Usuarios Únicos</div>
        <div class="kpi-value">{{ unique_users }}</div>
    </div>

    <div class="kpi-card animate-in">
        <div class="kpi-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z" />
                <line x1="4" y1="22" x2="4" y2="15" />
            </svg>
        </div>
        <div class="kpi-label">Total Mensajes</div>
        <div class="kpi-value">{{ messages_total }}</div>
    </div>
</div>

<!-- Charts -->
<div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 20V10M12 20V4M6 20v-6" />
    </svg>
    <h2>Tendencias</h2>
</div>
<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                </svg>
                Mensajes por Día (30 días)
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                </svg>
                Actividad por Hora
            </h3>
        </div>
        <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
        </div>
    </div>
</div>

<!-- Top Users -->
<div class="grid-2">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M23 21v-2a4 4 0 00-3-3.87" />
                    <path d="M16 3.13a4 4 0 010 7.75" />
                </svg>
                Top Usuarios
            </h3>
        </div>
        {% if top_users_data %}
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Usuario</th>
                        <th>Mensajes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in top_users_data %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>Usuario {{ user.name[-4:] }}</td>
                        <td><span class="badge badge-platform">{{ user.count }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state" style="padding:30px">
            <h3>Sin usuarios aún</h3>
            <p>Los usuarios aparecerán cuando empiecen a interactuar</p>
        </div>
        {% endif %}
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="3" width="20" height="14" rx="2" />
                    <line x1="8" y1="21" x2="16" y2="21" />
                    <line x1="12" y1="17" x2="12" y2="21" />
                </svg>
                Plataforma
            </h3>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:24px">
            <span class="badge badge-platform" style="font-size:14px;padding:8px 16px">Telegram</span>
            <span style="color:var(--text-secondary);font-size:13px">{{ messages_total }} mensajes totales</span>
        </div>
    </div>
</div>

<!-- AI Insights Section -->
<div class="section-header">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a4 4 0 014 4v1a1 1 0 001 1h1a4 4 0 010 8h-1a1 1 0 00-1 1v1a4 4 0 01-8 0v-1a1 1 0 00-1-1H6a4 4 0 010-8h1a1 1 0 001-1V6a4 4 0 014-4z" />
    </svg>
    <h2>Análisis IA</h2>
</div>
<div id="ai-insights-container">
    <div class="ai-loading">
        <div class="ai-loading-spinner"></div>
        <p>Analizando conversaciones con IA...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    if (typeof Chart === 'undefined') {
        document.querySelectorAll('.chart-container').forEach(c => {
            c.innerHTML = '<p style="color:var(--text-secondary);padding:20px;text-align:center">Error al cargar las gráficas. Recarga la página.</p>';
        });
    } else {
        Chart.defaults.color = 'rgba(255,255,255,0.35)';
        Chart.defaults.font.family = 'Inter';

        // Daily chart
        const dailyData = {{ daily_messages | tojson }};
        new Chart(document.getElementById('dailyChart'), {
            type: 'line',
            data: {
                labels: dailyData.map(d => d.date),
                datasets: [{
                    label: 'Mensajes',
                    data: dailyData.map(d => d.count),
                    borderColor: '#39FF14',
                    backgroundColor: (ctx) => {
                        const g = ctx.chart.ctx.createLinearGradient(0, 0, 0, 280);
                        g.addColorStop(0, 'rgba(57, 255, 20, 0.15)');
                        g.addColorStop(1, 'rgba(57, 255, 20, 0.0)');
                        return g;
                    },
                    fill: true, tension: 0.4, borderWidth: 2,
                    pointRadius: 0, pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#39FF14',
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(10,10,15,0.95)', borderColor: 'rgba(57,255,20,0.2)', borderWidth: 1, padding: 12, cornerRadius: 8 } },
                scales: {
                    x: { border: { display: false }, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { maxTicksLimit: 10, font: { size: 11 } } },
                    y: { border: { display: false }, grid: { color: 'rgba(255,255,255,0.03)' }, beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } } }
                }
            }
        });

        // Hourly chart
        const hourlyData = {{ hourly_messages | tojson }};
        new Chart(document.getElementById('hourlyChart'), {
            type: 'bar',
            data: {
                labels: hourlyData.map(d => d.hour),
                datasets: [{
                    label: 'Mensajes',
                    data: hourlyData.map(d => d.count),
                    backgroundColor: (ctx) => {
                        const g = ctx.chart.ctx.createLinearGradient(0, 280, 0, 0);
                        g.addColorStop(0, 'rgba(168, 85, 247, 0.05)');
                        g.addColorStop(1, 'rgba(168, 85, 247, 0.35)');
                        return g;
                    },
                    borderColor: 'rgba(168, 85, 247, 0.5)',
                    borderWidth: 1, borderRadius: 6,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(10,10,15,0.95)', borderColor: 'rgba(168,85,247,0.2)', borderWidth: 1, padding: 12, cornerRadius: 8 } },
                scales: {
                    x: { border: { display: false }, grid: { display: false }, ticks: { maxTicksLimit: 12, font: { size: 11 } } },
                    y: { border: { display: false }, grid: { color: 'rgba(255,255,255,0.03)' }, beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } } }
                }
            }
        });
    }

    // AI Insights
    fetch('/estadisticas/insights')
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('ai-insights-container');
            if (data.error) {
                container.innerHTML = '<div class="ai-error"><p>No se pudo generar el análisis: ' + data.error + '</p></div>';
                return;
            }
            container.innerHTML = `
                <div class="ai-insights-grid">
                    <div class="ai-insight-card ai-accent-green">
                        <div class="ai-insight-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg></div>
                        <h3>Preguntas Frecuentes</h3>
                        <div class="ai-insight-content">${data.preguntas_frecuentes || 'Sin datos suficientes'}</div>
                    </div>
                    <div class="ai-insight-card ai-accent-cyan">
                        <div class="ai-insight-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
                        <h3>Salas Populares</h3>
                        <div class="ai-insight-content">${data.salas_populares || 'Sin datos suficientes'}</div>
                    </div>
                    <div class="ai-insight-card ai-accent-purple">
                        <div class="ai-insight-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></div>
                        <h3>Sentimiento General</h3>
                        <div class="ai-insight-content">${data.sentimiento || 'Sin datos suficientes'}</div>
                    </div>
                    <div class="ai-insight-card ai-accent-amber">
                        <div class="ai-insight-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></div>
                        <h3>Sugerencias de Mejora</h3>
                        <div class="ai-insight-content">${data.sugerencias || 'Sin datos suficientes'}</div>
                    </div>
                </div>
            `;
        })
        .catch(() => {
            document.getElementById('ai-insights-container').innerHTML =
                '<div class="ai-error"><p>Error al conectar con el servicio de IA</p></div>';
        });
</script>
{% endblock %}